<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EXLUX Admin - ì²´í—˜ì‚¬ë¡€ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; word-break: keep-all; }
        .tab-content { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .wrap-text { word-break: break-all; overflow-wrap: break-word; white-space: normal; line-height: 1.5; }
        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        #login-overlay { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-gray-100 flex h-screen overflow-hidden">

    <div id="login-overlay">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-center">
            <h1 class="text-2xl font-black text-slate-900 mb-6 uppercase tracking-tighter">EXLUX ADMIN LOGIN</h1>
            <input type="password" id="adminPassword" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" class="w-full border-2 border-gray-200 p-4 rounded-xl mb-4 outline-none focus:border-blue-500 transition">
            <button onclick="checkAdmin()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg">ì ‘ì†í•˜ê¸°</button>
            <p class="text-gray-400 text-xs mt-4">ë¹„ë°€ë²ˆí˜¸ëŠ” 1204ì…ë‹ˆë‹¤.</p>
        </div>
    </div>

    <aside class="w-64 bg-slate-900 text-white flex-shrink-0 flex flex-col">
        <div class="p-6 font-black text-2xl border-b border-slate-700 text-center uppercase tracking-tighter">EXLUX Admin</div>
        <nav class="flex-1 mt-6 text-sm">
            <a onclick="showTab('dash')" id="nav-dash" class="block py-4 px-6 hover:bg-slate-800 cursor-pointer border-l-4 border-transparent transition"><i class="fas fa-chart-line w-6"></i> ëŒ€ì‹œë³´ë“œ</a>
            <a onclick="showTab('list')" id="nav-list" class="block py-4 px-6 hover:bg-slate-800 cursor-pointer border-l-4 border-transparent transition"><i class="fas fa-list w-6"></i> ì²´í—˜ì‚¬ë¡€ ë¦¬ìŠ¤íŠ¸</a>
            <a onclick="initRegisterMode()" id="nav-register" class="block py-4 px-6 hover:bg-slate-800 cursor-pointer border-l-4 border-blue-400 bg-slate-800 transition"><i class="fas fa-edit w-6"></i> ì²´í—˜ì‚¬ë¡€ ë“±ë¡</a>
        </nav>
    </aside>

    <main class="flex-1 overflow-y-auto p-8">
        <div id="tab-dash" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">ğŸ“Š ê´€ë¦¬ í†µê³„</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm border-t-4 border-blue-500">
                    <p class="text-gray-500 text-sm font-bold">ì „ì²´ ë“±ë¡ ì‚¬ë¡€</p>
                    <p id="stat-total" class="text-3xl font-bold mt-2">0ê±´</p>
                </div>
            </div>
            <p class="text-gray-400 italic">í˜„ì¬ ì‹œìŠ¤í…œì— ì €ì¥ëœ ì „ì²´ ë°ì´í„° ê°œìˆ˜ì…ë‹ˆë‹¤.</p>
        </div>

        <div id="tab-list" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">ğŸ“ ì²´í—˜ ì‚¬ë¡€ ë¦¬ìŠ¤íŠ¸</h2>
                <div class="flex gap-2">
                    <button onclick="exportData()" class="bg-green-600 text-white px-4 py-2 rounded text-xs font-bold hover:bg-green-700 shadow">ë°ì´í„° ì¶”ì¶œ(DBìš©)</button>
                    <button onclick="clearData()" class="text-xs text-gray-400 hover:text-red-500 underline">ë°ì´í„° ì „ì²´ ì´ˆê¸°í™”</button>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-gray-700 border-b">
                        <tr>
                            <th class="p-4">No</th>
                            <th class="p-4">ë“±ë¡ì¼</th>
                            <th class="p-4">ì„±í•¨ (ìˆ˜ì •)</th>
                            <th class="p-4">ë‚˜ì´/ì„±ë³„</th>
                            <th class="p-4">ì§€ì—­</th>
                            <th class="p-4">ì¦ìƒ</th>
                            <th class="p-4">ê¸°ëŠ¥</th>
                        </tr>
                    </thead>
                    <tbody id="caseTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-register" class="tab-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-800"><i class="fas fa-pen-fancy mr-2 text-blue-600"></i> ì²´í—˜ ì‚¬ë¡€ ë“±ë¡</h2>
            <div class="max-w-4xl bg-white p-8 rounded-xl shadow-lg border border-gray-200">
                <form id="registerForm" class="space-y-6">
                    <input type="hidden" id="reg-id">
                    <div class="border-b pb-4">
                        <h3 class="font-bold text-lg text-blue-900 mb-4">â‘  ê¸°ë³¸ ì •ë³´ ì…ë ¥</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <input type="text" id="reg-name" placeholder="ì„±í•¨" class="border p-3 rounded focus:border-blue-500 outline-none shadow-sm">
                            <select id="reg-year" class="border p-3 rounded shadow-sm"></select>
                            <select id="reg-month" class="border p-3 rounded shadow-sm"></select>
                            <select id="reg-day" class="border p-3 rounded shadow-sm"></select>
                            <select id="reg-gender" class="border p-3 rounded shadow-sm">
                                <option value="ë‚¨">ë‚¨ì„±</option>
                                <option value="ì—¬">ì—¬ì„±</option>
                            </select>
                            <select id="reg-sido" class="border p-3 rounded shadow-sm" onchange="updateSigungu()"></select>
                            <select id="reg-sigungu" class="border p-3 rounded shadow-sm md:col-span-2"></select>
                        </div>
                    </div>

                    <div class="border-b pb-4">
                        <h3 class="font-bold text-lg text-blue-900 mb-4">â‘¡ ì¦ìƒ ë° ì‚¬ìš© ì •ë³´</h3>
                        <div class="flex flex-wrap gap-3 mb-4 bg-gray-50 p-4 rounded border">
                            <label class="flex items-center cursor-pointer"><input type="checkbox" name="symptom" value="í—ˆë¦¬í†µì¦" class="mr-1">í—ˆë¦¬í†µì¦</label>
                            <label class="flex items-center cursor-pointer"><input type="checkbox" name="symptom" value="ëª©/ì–´ê¹¨" class="mr-1">ëª©/ì–´ê¹¨</label>
                            <label class="flex items-center cursor-pointer"><input type="checkbox" name="symptom" value="ë¬´ë¦/ê´€ì ˆ" class="mr-1">ë¬´ë¦/ê´€ì ˆ</label>
                            <label class="flex items-center cursor-pointer"><input type="checkbox" name="symptom" value="í˜ˆë‹¹/í˜ˆì••" class="mr-1">í˜ˆë‹¹/í˜ˆì••</label>
                            <label class="flex items-center cursor-pointer"><input type="checkbox" name="symptom" value="ë¶ˆë©´/ìš°ìš¸" class="mr-1">ë¶ˆë©´/ìš°ìš¸</label>
                            <div class="flex items-center gap-2">
                                <label class="flex items-center cursor-pointer"><input type="checkbox" id="etc-check" onchange="toggleEtcInput()">ê¸°íƒ€</label>
                                <input type="text" id="etc-input" placeholder="ì§ì ‘ì…ë ¥" class="border px-2 py-1 rounded text-sm hidden outline-none focus:border-blue-500 shadow-sm">
                            </div>
                        </div>
                        <select id="reg-period" class="w-full border p-3 rounded mb-4 shadow-sm">
                            <option value="10ì¼ ì´í•˜">10ì¼ ì´í•˜</option>
                            <option value="10ì¼ ì´ìƒ">10ì¼ ì´ìƒ</option>
                            <option value="20ì¼ ì´ìƒ">20ì¼ ì´ìƒ</option>
                            <option value="30ì¼ ì´ìƒ">30ì¼ ì´ìƒ</option>
                            <option value="ê³„ì† ì‚¬ìš© ì¤‘">ê³„ì† ì‚¬ìš© ì¤‘</option>
                        </select>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <textarea id="reg-desc-symptom" placeholder="êµ¬ì²´ì  ì¦ìƒ ë‚´ìš©" class="border p-3 rounded h-32 outline-none shadow-sm"></textarea>
                            <textarea id="reg-desc-change" placeholder="ì‚¬ìš© í›„ ë³€í™” (ê²°ê³¼)" class="border p-3 rounded h-32 outline-none shadow-sm"></textarea>
                        </div>
                    </div>

                    <div class="border-b pb-4">
                        <h3 class="font-bold text-lg text-blue-900 mb-4">â‘¢ ì‚¬ì§„ ì—…ë¡œë“œ (ìµœëŒ€ 4ì¥)</h3>
                        <div class="flex gap-4 items-start">
                            <div id="previewGrid" class="grid grid-cols-4 gap-2 flex-grow"></div>
                            <label id="uploadLabel" class="flex flex-col items-center justify-center w-24 h-24 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition shrink-0">
                                <i class="fas fa-plus text-gray-400 text-xl"></i>
                                <p class="text-[10px] text-gray-500 mt-1 font-bold">ì‚¬ì§„ ì¶”ê°€</p>
                                <input type="file" id="fileInput" class="hidden" accept="image/*" multiple onchange="handleFiles(this.files)">
                            </label>
                        </div>
                        <p class="text-xs text-blue-600 mt-2 font-bold">* ê³ í™”ì§ˆ ì‚¬ì§„ì„ ì˜¬ë ¤ë„ ìë™ìœ¼ë¡œ ìµœì í™”ë˜ì–´ ì €ì¥ ì‹¤íŒ¨ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.</p>
                    </div>

                    <div class="flex gap-4">
                        <button type="button" onclick="openPosterModal()" class="flex-1 bg-slate-800 text-white py-4 rounded-lg font-bold shadow-lg hover:bg-black transition"><i class="fas fa-id-card mr-2"></i>í¬ìŠ¤í„° ë³´ê¸°</button>
                        <button type="button" onclick="saveCase()" class="flex-1 bg-blue-600 text-white py-4 rounded-lg font-bold shadow-lg hover:bg-blue-700 transition"><i class="fas fa-save mr-2"></i>ê°¤ëŸ¬ë¦¬ ì €ì¥í•˜ê¸°</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <div id="posterModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="closePoster()"></div>
        <div class="relative bg-white rounded-2xl max-w-md w-full overflow-hidden shadow-2xl">
            <div class="bg-blue-900 text-white p-4 flex justify-between items-center">
                <span class="font-bold text-lg">ìµìŠ¤ëŸ­ìŠ¤ ì²´í—˜ ì‚¬ë¡€</span>
                <button onclick="closePoster()" class="text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 text-center">
                <div class="border-[4px] border-double border-blue-900 p-4 rounded-lg bg-gray-50 mb-4 text-center">
                    <h4 class="text-[10px] text-blue-600 font-bold tracking-[0.2em] mb-1 uppercase">Success Story</h4>
                    <h3 id="modal-name" class="text-2xl font-black text-gray-900 mb-2 tracking-tight">ê³ ê°ë‹˜</h3>
                    <p id="modal-meta" class="text-xs font-bold text-gray-600 border-t mt-2 pt-2"></p>
                </div>
                <div class="bg-yellow-50 p-3 rounded border border-yellow-100 mb-4">
                    <p id="modal-desc-symptom" class="text-sm text-gray-700 font-semibold wrap-text"></p>
                </div>
                <div id="modal-photo-grid" class="grid grid-cols-2 gap-2 h-48 mb-4"></div>
                <div class="bg-blue-600 text-white p-4 rounded-xl result-container shadow-lg">
                    <p id="modal-desc-change" class="font-bold text-lg leading-snug wrap-text"></p>
                </div>
            </div>
            <div class="p-5 bg-gray-100 border-t text-center shadow-2xl">
                <p class="text-blue-900 font-black text-lg mb-4 tracking-tighter">"ìµìŠ¤ëŸ­ìŠ¤ë¡œ ê±´ê°•ì„ ì°¾ìœ¼ì‹  ê²ƒì„ ì¶•í•˜í•©ë‹ˆë‹¤."</p>
                <button onclick="closePoster()" class="w-full bg-slate-800 text-white py-3 rounded-lg font-bold hover:bg-black transition shadow-md">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        let fileDataUrls = [];
        const regionData = {
            "ê²½ê¸°": ["ê°€í‰êµ°", "ê³ ì–‘ì‹œ", "ê³¼ì²œì‹œ", "ê´‘ëª…ì‹œ", "ê´‘ì£¼ì‹œ", "êµ¬ë¦¬ì‹œ", "êµ°í¬ì‹œ", "ê¹€í¬ì‹œ", "ë‚¨ì–‘ì£¼ì‹œ", "ë™ë‘ì²œì‹œ", "ë¶€ì²œì‹œ", "ì„±ë‚¨ì‹œ", "ìˆ˜ì›ì‹œ", "ì‹œí¥ì‹œ", "ì•ˆì‚°ì‹œ", "ì•ˆì„±ì‹œ", "ì•ˆì–‘ì‹œ", "ì–‘ì£¼ì‹œ", "ì–‘í‰êµ°", "ì—¬ì£¼ì‹œ", "ì—°ì²œêµ°", "ì˜¤ì‚°ì‹œ", "ìš©ì¸ì‹œ", "ì˜ì™•ì‹œ", "ì˜ì •ë¶€ì‹œ", "ì´ì²œì‹œ", "íŒŒì£¼ì‹œ", "í‰íƒì‹œ", "í¬ì²œì‹œ", "í•˜ë‚¨ì‹œ", "í™”ì„±ì‹œ"],
            "ì„œìš¸": ["ê°•ë‚¨êµ¬", "ê°•ë™êµ¬", "ê°•ë¶êµ¬", "ê°•ì„œêµ¬", "ê´€ì•…êµ¬", "ê´‘ì§„êµ¬", "êµ¬ë¡œêµ¬", "ê¸ˆì²œêµ¬", "ë…¸ì›êµ¬", "ë„ë´‰êµ¬", "ë™ëŒ€ë¬¸êµ¬", "ë™ì‘êµ¬", "ë§ˆí¬êµ¬", "ì„œëŒ€ë¬¸êµ¬", "ì„œì´ˆêµ¬", "ì„±ë™êµ¬", "ì„±ë¶êµ¬", "ì†¡íŒŒêµ¬", "ì–‘ì²œêµ¬", "ì˜ë“±í¬êµ¬", "ìš©ì‚°êµ¬", "ì€í‰êµ¬", "ì¢…ë¡œêµ¬", "ì¤‘êµ¬", "ì¤‘ë‘êµ¬"],
            "ë¶€ì‚°": ["ê°•ì„œêµ¬", "ê¸ˆì •êµ¬", "ê¸°ì¥êµ°", "ë‚¨êµ¬", "ë™êµ¬", "ë™ë˜êµ¬", "ë¶€ì‚°ì§„êµ¬", "ë¶êµ¬", "ì‚¬ìƒêµ¬", "ì‚¬í•˜êµ¬", "ì„œêµ¬", "ìˆ˜ì˜êµ¬", "ì—°ì œêµ¬", "ì˜ë„êµ¬", "ì¤‘êµ¬", "í•´ìš´ëŒ€êµ¬"],
            "ê²½ë‚¨": ["ê±°ì œì‹œ", "ê±°ì°½êµ°", "ê³ ì„±êµ°", "ê¹€í•´ì‹œ", "ë‚¨í•´êµ°", "ë°€ì–‘ì‹œ", "ì‚¬ì²œì‹œ", "ì‚°ì²­êµ°", "ì–‘ì‚°ì‹œ", "ì˜ë ¹êµ°", "ì§„ì£¼ì‹œ", "ì°½ë…•êµ°", "ì°½ì›ì‹œ", "í†µì˜ì‹œ", "í•˜ë™êµ°", "í•¨ì•ˆêµ°", "í•¨ì–‘êµ°", "í•©ì²œêµ°"],
            "ì¸ì²œ": ["ê°•í™”êµ°", "ê³„ì–‘êµ¬", "ë‚¨ë™êµ¬", "ë™êµ¬", "ë¯¸ì¶”í™€êµ¬", "ë¶€í‰êµ¬", "ì„œêµ¬", "ì—°ìˆ˜êµ¬", "ì˜¹ì§„êµ°", "ì¤‘êµ¬"],
            "ê²½ë¶": ["ê²½ì‚°ì‹œ", "ê²½ì£¼ì‹œ", "ê³ ë ¹êµ°", "êµ¬ë¯¸ì‹œ", "êµ°ìœ„êµ°", "ê¹€ì²œì‹œ", "ë¬¸ê²½ì‹œ", "ë´‰í™”êµ°", "ìƒì£¼ì‹œ", "ì„±ì£¼êµ°", "ì•ˆë™ì‹œ", "ì˜ë•êµ°", "ì˜ì–‘êµ°", "ì˜ì£¼ì‹œ", "ì˜ì²œì‹œ", "ì˜ˆì²œêµ°", "ìš¸ë¦‰êµ°", "ìš¸ì§„êµ°", "ì˜ì„±êµ°", "ì²­ë„êµ°", "ì²­ì†¡êµ°", "ì¹ ê³¡êµ°", "í¬í•­ì‹œ"],
            "ëŒ€êµ¬": ["êµ°ìœ„êµ°", "ë‚¨êµ¬", "ë‹¬ì„œêµ¬", "ë‹¬ì„±êµ°", "ë™êµ¬", "ë¶êµ¬", "ì„œêµ¬", "ìˆ˜ì„±êµ¬", "ì¤‘êµ¬"],
            "ì¶©ë‚¨": ["ê³„ë£¡ì‹œ", "ê³µì£¼ì‹œ", "ê¸ˆì‚°êµ°", "ë…¼ì‚°ì‹œ", "ë‹¹ì§„ì‹œ", "ë¶€ì—¬êµ°", "ì„œì‚°ì‹œ", "ì„œì²œêµ°", "ì•„ì‚°ì‹œ", "ì˜ˆì‚°êµ°", "ì²œì•ˆì‹œ", "ì²­ì–‘êµ°", "íƒœì•ˆêµ°", "í™ì„±êµ°"],
            "ì „ë‚¨": ["ê°•ì§„êµ°", "ê³ í¥êµ°", "ê³¡ì„±êµ°", "ê´‘ì–‘ì‹œ", "êµ¬ë¡€êµ°", "ë‚˜ì£¼ì‹œ", "ë‹´ì–‘êµ°", "ëª©í¬ì‹œ", "ë¬´ì•ˆêµ°", "ë³´ì„±êµ°", "ìˆœì²œì‹œ", "ì‹ ì•ˆêµ°", "ì—¬ìˆ˜ì‹œ", "ì˜ê´‘êµ°", "ì˜ì•”êµ°", "ì™„ë„êµ°", "ì¥ì„±êµ°", "ì¥í¥êµ°", "ì§„ë„êµ°", "í•¨í‰êµ°", "í•´ë‚¨êµ°", "í™”ìˆœêµ°"],
            "ì „ë¶": ["ê³ ì°½êµ°", "êµ°ì‚°ì‹œ", "ê¹€ì œì‹œ", "ë‚¨ì›ì‹œ", "ë¬´ì£¼êµ°", "ë¶€ì•ˆêµ°", "ìˆœì°½êµ°", "ì™„ì£¼êµ°", "ìµì‚°ì‹œ", "ì„ì‹¤êµ°", "ì¥ìˆ˜êµ°", "ì „ì£¼ì‹œ", "ì •ìì‹œ", "ì§„ì•ˆêµ°"],
            "ì¶©ë¶": ["ê´´ì‚°êµ°", "ë‹¨ì–‘êµ°", "ë³´ì€êµ°", "ì˜ë™êµ°", "ì˜¥ì²œêµ°", "ìŒì„±êµ°", "ì œì²œì‹œ", "ì¦í‰êµ°", "ì§„ì²œêµ°", "ì²­ì£¼ì‹œ", "ì¶©ì£¼ì‹œ"],
            "ê°•ì›": ["ê°•ë¦‰ì‹œ", "ê³ ì„±êµ°", "ë™í•´ì‹œ", "ì‚¼ì²™ì‹œ", "ì†ì´ˆì‹œ", "ì–‘êµ¬êµ°", "ì–‘ì–‘êµ°", "ì˜ì›”êµ°", "ì›ì£¼ì‹œ", "ì¸ì œêµ°", "ì •ì„ êµ°", "ì² ì›êµ°", "ì¶˜ì²œì‹œ", "íƒœë°±ì‹œ", "í‰ì°½êµ°", "í™ì²œêµ°", "í™”ì²œêµ°", "íš¡ì„±êµ°"],
            "ëŒ€ì „": ["ëŒ€ë•êµ¬", "ë™êµ¬", "ì„œêµ¬", "ìœ ì„±êµ¬", "ì¤‘êµ¬"],
            "ê´‘ì£¼": ["ê´‘ì‚°êµ¬", "ë‚¨êµ¬", "ë™êµ¬", "ë¶êµ¬", "ì„œêµ¬"],
            "ìš¸ì‚°": ["ë‚¨êµ¬", "ë™êµ¬", "ë¶êµ¬", "ìš¸ì£¼êµ°", "ì¤‘êµ¬"],
            "ì œì£¼": ["ì„œê·€í¬ì‹œ", "ì œì£¼ì‹œ"],
            "ì„¸ì¢…": ["ì„¸ì¢…ì‹œ"]
        };

        function checkAdmin() {
            if(document.getElementById('adminPassword').value === "1204") {
                document.getElementById('login-overlay').style.display = 'none';
                refreshAllViews();
            } else { alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); }
        }

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if(fileDataUrls.length >= 4) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        const max_size = 1024; // ì´ë¯¸ì§€ ìë™ ìµœì í™” í•µì‹¬ ë¡œì§
                        if (width > height) { if (width > max_size) { height *= max_size / width; width = max_size; } }
                        else { if (height > max_size) { width *= max_size / height; height = max_size; } }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        fileDataUrls.push(canvas.toDataURL('image/jpeg', 0.7)); // í’ˆì§ˆ 70% ì••ì¶• ì €ì¥
                        renderPreviews();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function saveCase() {
            const name = document.getElementById('reg-name').value;
            if(!name) { alert("ì„±í•¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            const data = {
                id: document.getElementById('reg-id').value ? parseInt(document.getElementById('reg-id').value) : Date.now(),
                date: new Date().toLocaleDateString(),
                name: name,
                age: getAge(),
                gender: document.getElementById('reg-gender').value,
                region: document.getElementById('reg-sido').value + ' ' + document.getElementById('reg-sigungu').value,
                symptoms: Array.from(document.querySelectorAll('input[name="symptom"]:checked')).map(c => c.value).join(', '),
                descSymptom: document.getElementById('reg-desc-symptom').value,
                descChange: document.getElementById('reg-desc-change').value,
                photos: fileDataUrls
            };
            let cs = loadCases();
            const idx = cs.findIndex(c => c.id == data.id);
            if(idx !== -1) cs[idx] = data; else cs.unshift(data);
            try {
                localStorage.setItem('exlux_cases', JSON.stringify(cs));
                alert('ê°¤ëŸ¬ë¦¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                initRegisterMode(false); refreshAllViews(); showTab('list');
            } catch (e) {
                alert("âš ï¸ ì €ì¥ ê³µê°„ ë¶€ì¡±! ë¦¬ìŠ¤íŠ¸ ì¶”ì¶œ í›„ ì´ˆê¸°í™”ë¥¼ ì§„í–‰í•˜ì„¸ìš”.");
            }
        }

        function exportData() {
            const dataStr = "const exlux_cases = " + JSON.stringify(loadCases(), null, 2) + ";";
            const blob = new Blob([dataStr], {type: "text/javascript"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = "exlux_db.js"; a.click();
            alert("DB íŒŒì¼ì´ ì¶”ì¶œë˜ì—ˆìŠµë‹ˆë‹¤. GitHubì— ì˜¬ë ¤ì£¼ì„¸ìš”!");
        }

        function loadCases() { const d = localStorage.getItem('exlux_cases'); return d ? JSON.parse(d) : []; }
        function renderPreviews() {
            const grid = document.getElementById('previewGrid');
            grid.innerHTML = fileDataUrls.map((url, i) => `<div class="relative aspect-square border rounded overflow-hidden shadow-sm"><img src="${url}" class="w-full h-full object-cover"><button type="button" onclick="fileDataUrls.splice(${i},1);renderPreviews();" class="absolute top-0 right-0 bg-red-600 text-white w-6 h-6 flex items-center justify-center font-bold">Ã—</button></div>`).join('');
            document.getElementById('uploadLabel').style.display = fileDataUrls.length >= 4 ? 'none' : 'flex';
        }
        function initForm() {
            const y = document.getElementById('reg-year'); const m = document.getElementById('reg-month'); const d = document.getElementById('reg-day'); const s = document.getElementById('reg-sido');
            for(let i=2026; i>=1926; i--) y.add(new Option(i+'ë…„', i));
            for(let i=1; i<=12; i++) m.add(new Option(i+'ì›”', i));
            for(let i=1; i<=31; i++) d.add(new Option(i+'ì¼', i));
            Object.keys(regionData).forEach(sid => s.add(new Option(sid, sid)));
            updateSigungu();
        }
        function updateSigungu() {
            const s = document.getElementById('reg-sido').value; const sg = document.getElementById('reg-sigungu');
            sg.innerHTML = '<option value="">ì„ íƒ</option>';
            if(s && regionData[s]) regionData[s].forEach(sig => sg.add(new Option(sig, sig)));
        }
        function getAge() { const y = parseInt(document.getElementById('reg-year').value); return y ? (2026 - y + 1) + "ì„¸" : ""; }
        function showTab(id) { 
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden')); 
            document.getElementById('tab-'+id).classList.remove('hidden'); 
            refreshAllViews();
        }
        function refreshAllViews() {
            const cs = loadCases(); document.getElementById('stat-total').innerText = cs.length + "ê±´";
            const tb = document.getElementById('caseTableBody');
            tb.innerHTML = cs.map((c, i) => `<tr class="border-b hover:bg-gray-50 transition"><td class="p-4">${cs.length-i}</td><td class="p-4 text-xs">${c.date}</td><td class="p-4 font-bold cursor-pointer underline text-blue-700" onclick="editCase(${c.id})">${c.name}</td><td class="p-4 text-xs">${c.age}/${c.gender}</td><td class="p-4 text-xs">${c.region}</td><td class="p-4 text-xs truncate max-w-[120px]">${c.symptoms}</td><td class="p-4"><button onclick="deleteCase(${c.id})" class="text-red-500">ì‚­ì œ</button></td></tr>`).join('');
        }
        function deleteCase(id) { if(confirm('ì‚¬ë¡€ë¥¼ ì‚­ì œí• ê¹Œìš”?')) { localStorage.setItem('exlux_cases', JSON.stringify(loadCases().filter(c => c.id !== id))); refreshAllViews(); } }
        function editCase(id) {
            const c = loadCases().find(c => c.id === id); if(!c) return;
            showTab('register'); document.getElementById('reg-id').value = c.id; document.getElementById('reg-name').value = c.name;
            if (c.region) { const p = c.region.split(' '); document.getElementById('reg-sido').value = p[0]; updateSigungu(); if(p[1]) document.getElementById('reg-sigungu').value = p[1]; }
            document.getElementById('reg-desc-symptom').value = c.descSymptom || ""; document.getElementById('reg-desc-change').value = c.descChange || "";
            fileDataUrls = c.photos || []; renderPreviews();
        }
        function initRegisterMode(mv = true) { document.getElementById('registerForm').reset(); document.getElementById('reg-id').value = ""; fileDataUrls = []; renderPreviews(); if(mv) showTab('register'); }
        function openPosterModal() {
            const n = document.getElementById('reg-name').value;
            document.getElementById('modal-name').innerText = (n[0] || "") + "*" + (n[n.length-1] || "") + " ê³ ê°ë‹˜";
            document.getElementById('modal-meta').innerText = `${getAge()} | ${document.getElementById('reg-gender').value}`;
            document.getElementById('modal-desc-change').innerText = document.getElementById('reg-desc-change').value || "ì‚¬ìš© í›„ ë³€í™” ë¯¸ì…ë ¥";
            const g = document.getElementById('modal-photo-grid'); g.innerHTML = fileDataUrls.map(url => `<div class="border rounded overflow-hidden shadow-inner"><img src="${url}" class="w-full h-full object-cover"></div>`).join('');
            document.getElementById('posterModal').classList.remove('hidden');
        }
        function closePoster() { document.getElementById('posterModal').classList.add('hidden'); }
        function clearData() { if(confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?')) { localStorage.removeItem('exlux_cases'); refreshAllViews(); } }
        function toggleEtcInput() { document.getElementById('etc-input').style.display = document.getElementById('etc-check').checked ? 'inline-block' : 'none'; }
        initForm();
    </script>
</body>
</html>
