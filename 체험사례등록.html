<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì²´í—˜ ì‚¬ë¡€ ë“±ë¡ ë° ì¡°íšŒ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #0056b3; --accent: #3498db; --bg: #f4f6f9; --danger: #e74c3c; }
        body { font-family: 'Pretendard', sans-serif; margin: 0; padding: 20px; background-color: var(--bg); color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { border-bottom: 3px solid var(--primary); padding-bottom: 15px; margin-top: 0; color: var(--primary); }
        .form-row { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 300px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        
        .preview-box { width: 100px; height: 100px; border-radius: 6px; overflow: hidden; border: 1px solid #ddd; position: relative; flex-shrink: 0; }
        .preview-box img { width: 100%; height: 100%; object-fit: cover; }
        .btn-del-photo { 
            position: absolute; top: 0; right: 0; 
            background: rgba(231, 76, 60, 0.9); color: white; 
            border: none; cursor: pointer; width: 24px; height: 24px; 
            font-weight: bold; font-size: 14px; display: flex; 
            align-items: center; justify-content: center;
            border-bottom-left-radius: 6px; z-index: 10;
        }
        .btn-del-photo:hover { background: red; }

        .btn-group { margin-top: 30px; text-align: center; display: flex; gap: 10px; justify-content: center; }
        button { padding: 12px 30px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; font-size: 16px; }
        button:hover { opacity: 0.9; }
        .btn-submit { background-color: var(--accent); }
        .btn-poster { background-color: var(--primary); }
        .btn-cancel { background-color: #95a5a6; }
        
        /* [í¬ìŠ¤í„° ìŠ¤íƒ€ì¼] */
        #posterWrapper { display: none; margin-top: 50px; text-align: center; }
        #posterArea { 
            width: 260mm; min-height: 297mm; 
            background: white; margin: 0 auto; 
            padding: 15mm; text-align: left; 
            border: 1px solid #eee; 
            border-top: 15mm solid var(--primary);
            box-sizing: border-box;
        }
        .p-title { font-size: 36px; font-weight: 900; margin-bottom: 10px; letter-spacing: -1px; line-height: 1.2; }
        .p-info { font-size: 20px; font-weight: 700; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 25px; color: #555; }
        .p-label { background: var(--primary); color: white; padding: 5px 15px; border-radius: 4px; font-weight: bold; display: inline-block; margin-bottom: 8px; font-size: 16px; }
        
        .p-content { 
            font-size: 17px; line-height: 1.5; margin-bottom: 20px; 
            white-space: pre-wrap; word-wrap: break-word; word-break: break-all; width: 100%; 
        }
        
        .p-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .p-grid img { 
            width: 100%; height: 200px; object-fit: cover; 
            border-radius: 6px; border: 1px solid #eee; 
        }
    </style>
</head>
<body>

<div class="container">
    <h2 id="pageTitle">ğŸ“ ì²´í—˜ ì‚¬ë¡€ ë“±ë¡</h2>
    <form id="expForm">
        <input type="hidden" id="editId">
        <div class="form-row">
            <div class="col"><label>ë“±ë¡ì¼</label><input type="text" id="regDate" readonly style="background:#f0f0f0;"></div>
            <div class="col"><label>ì„±í•¨</label><input type="text" id="userName" placeholder="ì˜ˆ: ì´ì„±ê¸°"></div>
        </div>
        <div class="form-row">
            <div class="col">
                <label>ìƒë…„ì›”ì¼</label>
                <div style="display:flex; gap:5px;">
                    <select id="birthYear" onchange="updateAge()"></select>
                    <select id="birthMonth"></select>
                    <select id="birthDay"></select>
                </div>
                <small id="ageDisplay" style="color:var(--primary); font-weight:bold; margin-top:5px; display:block;">ë§Œ 0ì„¸</small>
            </div>
            <div class="col"><label>ì„±ë³„</label><select id="gender"><option value="ë‚¨">ë‚¨ì„±</option><option value="ì—¬">ì—¬ì„±</option></select></div>
        </div>
        
        <div class="form-row">
            <div class="col"><label>ì‹œ/ë„</label><select id="areaStep1" onchange="updateArea2()"><option value="">ì‹œ/ë„ ì„ íƒ</option></select></div>
            <div class="col"><label>ì‹œ/êµ°/êµ¬</label><select id="areaStep2"><option value="">ì‹œ/êµ°/êµ¬ ì„ íƒ</option></select></div>
        </div>

        <div class="form-row">
            <div class="col">
                <label>í†µì¦/ì¦ìƒ</label>
                <select id="symptomSelect" onchange="toggleEtc()">
                    <option value="í˜ˆë‹¹/í˜ˆì••">í˜ˆë‹¹/í˜ˆì••</option><option value="ê´€ì ˆ/ë¬´ë¦">ê´€ì ˆ/ë¬´ë¦</option><option value="í—ˆë¦¬/ë””ìŠ¤í¬">í—ˆë¦¬/ë””ìŠ¤í¬</option><option value="ì–´ê¹¨/ëª©">ì–´ê¹¨/ëª©</option><option value="ê¸°íƒ€">ê¸°íƒ€</option>
                </select>
                <input type="text" id="etc_input" style="display:none; margin-top:5px;" placeholder="ì§ì ‘ ì…ë ¥">
            </div>
            <div class="col"><label>ì‚¬ìš© ê¸°ê°„</label><select id="usePeriod"><option value="10ì¼">10ì¼</option><option value="20ì¼">20ì¼</option><option value="30ì¼ ì´ìƒ">30ì¼ ì´ìƒ</option><option value="ê³„ì†ì‚¬ìš©ì¤‘">ê³„ì†ì‚¬ìš©ì¤‘</option></select></div>
        </div>
        <div class="form-row"><div class="col"><label>[êµ¬ì²´ì ì¸ ì¦ìƒ]</label><textarea id="descSituation" rows="2" placeholder="ë‚´ìš©ì´ ê¸¸ì–´ë„ ìë™ìœ¼ë¡œ ì¤„ë°”ê¿ˆë˜ì–´ í¬ìŠ¤í„°ì— ì˜ ë“¤ì–´ê°‘ë‹ˆë‹¤."></textarea></div></div>
        <div class="form-row"><div class="col"><label>[ì‚¬ìš© ë°©ë²•]</label><textarea id="descUsage" rows="2" placeholder="ì˜ˆ: í•˜ë£¨ 2íšŒ 30ë¶„ì”© ë¬´ë¦ ë¶€ìœ„ì— ì‚¬ìš©"></textarea></div></div>
        <div class="form-row"><div class="col"><label>[ì‚¬ìš© í›„ ë³€í™”]</label><textarea id="descResult" rows="2" placeholder="ì˜ˆ: 3ì¼ í›„ë¶€í„° í†µì¦ì´ ì¤„ê³  ê±·ê¸°ê°€ í¸í•´ì§"></textarea></div></div>
        
        <div style="margin-top:20px;">
            <label>ğŸ“· ì‚¬ì§„ ì²¨ë¶€ (ìµœëŒ€ 4ì¥, 1ì¥ë‹¹ 5MB ë¯¸ë§Œ)</label>
            <input type="file" id="photoInput" multiple accept="image/*" 
                   onclick="alert('ì‚¬ì§„ì€ 1ì¥ë‹¹ 5MB ë¯¸ë§Œì´ì–´ì•¼ í•©ë‹ˆë‹¤.\n(í° ì‚¬ì§„ì€ ìë™ìœ¼ë¡œ ì••ì¶•ë©ë‹ˆë‹¤)')" 
                   onchange="previewImages()">
            <div id="previewContainer" style="display:flex; margin-top:10px; gap:10px; flex-wrap: wrap;"></div>
        </div>

        <div class="btn-group">
            <button type="button" class="btn-cancel" onclick="location.href='ì²´í—˜ì‚¬ë¡€ë¦¬ìŠ¤íŠ¸.html'">ëª©ë¡ìœ¼ë¡œ</button>
            <button type="button" class="btn-poster" onclick="makePoster()">ğŸ¨ í¬ìŠ¤í„° ë³´ê¸°</button>
            <button type="button" class="btn-submit" onclick="saveData()">ì €ì¥í•˜ê¸°</button>
        </div>
    </form>
</div>

<div id="posterWrapper">
    <div id="posterArea">
        <div style="color:var(--primary); font-weight:bold; letter-spacing:1px; margin-bottom:10px;">OFFICIAL REPORT /// 2026</div>
        <div class="p-title">ìµìŠ¤ëŸ­ìŠ¤ ë¦¬ì–¼ ì²´í—˜ ì‚¬ë¡€</div>
        <div id="p-info" class="p-info">-</div>
        
        <div class="p-section"><div class="p-label">ì¦ìƒ</div><div id="p-sym" class="p-content" style="font-weight:bold;">-</div></div>
        <div class="p-section"><div class="p-label">êµ¬ì²´ì ì¸ ì¦ìƒ</div><div id="p-desc1" class="p-content">-</div></div>
        <div class="p-section"><div class="p-label">ì‚¬ìš© ë°©ë²•</div><div id="p-desc2" class="p-content">-</div></div>
        <div class="p-section"><div class="p-label">ì‚¬ìš© í›„ ë³€í™”</div><div id="p-desc3" class="p-content" style="color:#e74c3c; font-weight:bold;">-</div></div>
        
        <div id="p-photos" class="p-grid"></div>
        <div style="margin-top:40px; border-top:1px solid #eee; padding-top:20px; text-align:center; color:#888; font-size:14px;">HEALTHCARE SOLUTION EXLLY</div>
    </div>
    <div style="text-align:center; margin-top:20px; padding-bottom:50px;">
        <button class="btn-submit" onclick="downloadPoster()">ì´ë¯¸ì§€ë¡œ ë‹¤ìš´ë¡œë“œ (PNG)</button>
    </div>
</div>

<script>
    // [GitHub ì—°ê²° ì„¤ì • - ghp_... í‚¤ ì ìš©]
    const GITHUB_TOKEN = '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'; 
    const REPO_OWNER = 'EXLUXANSAN';
    const REPO_NAME = 'exluxansan-web-site';

    const regions = { 'ì„œìš¸': ['ê°•ë‚¨êµ¬','ê°•ë™êµ¬','ê°•ì„œêµ¬'], 'ê²½ê¸°': ['ìˆ˜ì›ì‹œ','ì„±ë‚¨ì‹œ','ì•ˆì‚°ì‹œ','í™”ì„±ì‹œ','í‰íƒì‹œ'], 'ì¸ì²œ': ['ë¶€í‰êµ¬','ë‚¨ë™êµ¬'] };

    window.onload = function() {
        initForm();
        const editId = localStorage.getItem('edit_case_id');
        if (editId) { checkEditMode(editId); } else { resetFormFields(); }
    };

    function initForm() {
        document.getElementById('regDate').value = new Date().toLocaleDateString();
        const y = document.getElementById('birthYear');
        for(let i=2026; i>=1930; i--) y.add(new Option(i+"ë…„", i));
        y.value = 1963;
        const m = document.getElementById('birthMonth');
        for(let i=1; i<=12; i++) m.add(new Option(i+"ì›”", i<10?"0"+i:i));
        const d = document.getElementById('birthDay');
        for(let i=1; i<=31; i++) d.add(new Option(i+"ì¼", i<10?"0"+i:i));
        const r = document.getElementById('areaStep1');
        r.innerHTML = '<option value="">ì‹œ/ë„ ì„ íƒ</option>';
        const fullRegions = {
            'ì„œìš¸': ['ê°•ë‚¨êµ¬','ê°•ë™êµ¬','ê°•ë¶êµ¬','ê°•ì„œêµ¬','ê´€ì•…êµ¬','ê´‘ì§„êµ¬','êµ¬ë¡œêµ¬','ê¸ˆì²œêµ¬','ë…¸ì›êµ¬','ë„ë´‰êµ¬','ë™ëŒ€ë¬¸êµ¬','ë™ì‘êµ¬','ë§ˆí¬êµ¬','ì„œëŒ€ë¬¸êµ¬','ì„œì´ˆêµ¬','ì„±ë™êµ¬','ì„±ë¶êµ¬','ì†¡íŒŒêµ¬','ì–‘ì²œêµ¬','ì˜ë“±í¬êµ¬','ìš©ì‚°êµ¬','ì€í‰êµ¬','ì¢…ë¡œêµ¬','ì¤‘êµ¬','ì¤‘ë‘êµ¬'],
            'ê²½ê¸°': ['ê°€í‰êµ°','ê³ ì–‘ì‹œ','ê³¼ì²œì‹œ','ê´‘ëª…ì‹œ','ê´‘ì£¼ì‹œ','êµ¬ë¦¬ì‹œ','êµ°í¬ì‹œ','ê¹€í¬ì‹œ','ë‚¨ì–‘ì£¼ì‹œ','ë™ë‘ì²œì‹œ','ë¶€ì²œì‹œ','ì„±ë‚¨ì‹œ','ìˆ˜ì›ì‹œ','ì‹œí¥ì‹œ','ì•ˆì‚°ì‹œ','ì•ˆì„±ì‹œ','ì•ˆì–‘ì‹œ','ì–‘ì£¼ì‹œ','ì–‘í‰êµ°','ì—¬ì£¼ì‹œ','ì—°ì²œêµ°','ì˜¤ì‚°ì‹œ','ìš©ì¸ì‹œ','ì˜ì™•ì‹œ','ì˜ì •ë¶€ì‹œ','ì´ì²œì‹œ','íŒŒì£¼ì‹œ','í‰íƒì‹œ','í¬ì²œì‹œ','í•˜ë‚¨ì‹œ','í™”ì„±ì‹œ'],
            'ì¸ì²œ': ['ê°•í™”êµ°','ê³„ì–‘êµ¬','ë‚¨ë™êµ¬','ë™êµ¬','ë¯¸ì¶”í™€êµ¬','ë¶€í‰êµ¬','ì„œêµ¬','ì—°ìˆ˜êµ¬','ì˜¹ì§„êµ°','ì¤‘êµ¬'],
            'ë¶€ì‚°': ['ê°•ì„œêµ¬','ê¸ˆì •êµ¬','ê¸°ì¥êµ°','ë‚¨êµ¬','ë™êµ¬','ë™ë˜êµ¬','ë¶€ì‚°ì§„êµ¬','ë¶êµ¬','ì‚¬ìƒêµ¬','ì‚¬í•˜êµ¬','ì„œêµ¬','ìˆ˜ì˜êµ¬','ì—°ì œêµ¬','ì˜ë„êµ¬','ì¤‘êµ¬','í•´ìš´ëŒ€êµ¬'],
            'ëŒ€êµ¬': ['êµ°ìœ„êµ°','ë‚¨êµ¬','ë‹¬ì„œêµ¬','ë‹¬ì„±êµ°','ë™êµ¬','ë¶êµ¬','ì„œêµ¬','ìˆ˜ì„±êµ¬','ì¤‘êµ¬'],
            'ê´‘ì£¼': ['ê´‘ì‚°êµ¬','ë‚¨êµ¬','ë™êµ¬','ë¶êµ¬','ì„œêµ¬'],
            'ëŒ€ì „': ['ëŒ€ë•êµ¬','ë™êµ¬','ì„œêµ¬','ìœ ì„±êµ¬','ì¤‘êµ¬'],
            'ìš¸ì‚°': ['ë‚¨êµ¬','ë™êµ¬','ë¶êµ¬','ìš¸ì£¼êµ°','ì¤‘êµ¬'],
            'ì„¸ì¢…': ['ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ'],
            'ê°•ì›': ['ê°•ë¦‰ì‹œ','ê³ ì„±êµ°','ë™í•´ì‹œ','ì‚¼ì²™ì‹œ','ì†ì´ˆì‹œ','ì–‘êµ¬êµ°','ì–‘ì–‘êµ°','ì˜ì›”êµ°','ì›ì£¼ì‹œ','ì¸ì œêµ°','ì •ì„ êµ°','ì² ì›êµ°','ì¶˜ì²œì‹œ','íƒœë°±ì‹œ','í‰ì°½êµ°','í™ì²œêµ°','í™”ì²œêµ°','íš¡ì„±êµ°'],
            'ì¶©ë¶': ['ê´´ì‚°êµ°','ë‹¨ì–‘êµ°','ë³´ì€êµ°','ì˜ë™êµ°','ì˜¥ì²œêµ°','ìŒì„±êµ°','ì œì²œì‹œ','ì¦í‰êµ°','ì§„ì²œêµ°','ì²­ì£¼ì‹œ','ì¶©ì£¼ì‹œ'],
            'ì¶©ë‚¨': ['ê³„ë£¡ì‹œ','ê³µì£¼ì‹œ','ê¸ˆì‚°êµ°','ë…¼ì‚°ì‹œ','ë‹¹ì§„ì‹œ','ë³´ë ¹ì‹œ','ë¶€ì—¬êµ°','ì„œì‚°ì‹œ','ì„œì²œêµ°','ì•„ì‚°ì‹œ','ì˜ˆì‚°êµ°','ì²œì•ˆì‹œ','ì²­ì–‘êµ°','íƒœì•ˆêµ°','í™ì„±êµ°'],
            'ì „ë¶': ['ê³ ì°½êµ°','êµ°ì‚°ì‹œ','ê¹€ì œì‹œ','ë‚¨ì›ì‹œ','ë¬´ì£¼êµ°','ë¶€ì•ˆêµ°','ìˆœì°½êµ°','ì™„ì£¼êµ°','ìµì‚°ì‹œ','ì„ì‹¤êµ°','ì¥ìˆ˜êµ°','ì „ì£¼ì‹œ','ì •ìì‹œ','ì§„ì•ˆêµ°'],
            'ì „ë‚¨': ['ê°•ì§„êµ°','ê³ í¥êµ°','ê³¡ì„±êµ°','ê´‘ì–‘ì‹œ','êµ¬ë¡€êµ°','ë‚˜ì£¼ì‹œ','ë‹´ì–‘êµ°','ëª©í¬ì‹œ','ë¬´ì•ˆêµ°','ë³´ì„±êµ°','ìˆœì²œì‹œ','ì‹ ì•ˆêµ°','ì—¬ìˆ˜ì‹œ','ì˜ê´‘êµ°','ì˜ì•”êµ°','ì™„ë„êµ°','ì¥ì„±êµ°','ì¥í¥êµ°','ì§„ë„êµ°','í•¨í‰êµ°','í•´ë‚¨êµ°','í™”ìˆœêµ°'],
            'ê²½ë¶': ['ê²½ì‚°ì‹œ','ê²½ì£¼ì‹œ','ê³ ë ¹êµ°','êµ¬ë¯¸ì‹œ','ê¹€ì²œì‹œ','ë¬¸ê²½ì‹œ','ë´‰í™”êµ°','ìƒì£¼ì‹œ','ì„±ì£¼êµ°','ì•ˆë™ì‹œ','ì˜ë•êµ°','ì˜ì–‘êµ°','ì˜ì£¼ì‹œ','ì˜ì²œì‹œ','ì˜ˆì²œêµ°','ìš¸ë¦‰êµ°','ìš¸ì§„êµ°','ì˜ì„±êµ°','ì²­ë„êµ°','ì²­ì†¡êµ°','ì¹ ê³¡êµ°','í¬í•­ì‹œ'],
            'ê²½ë‚¨': ['ê±°ì œì‹œ','ê±°ì°½êµ°','ê³ ì„±êµ°','ê¹€í•´ì‹œ','ë‚¨í•´êµ°','ë°€ì–‘ì‹œ','ì‚¬ì²œì‹œ','ì‚°ì²­êµ°','ì–‘ì‚°ì‹œ','ì˜ë ¹êµ°','ì§„ì£¼ì‹œ','ì°½ë…•êµ°','ì°½ì›ì‹œ','í†µì˜ì‹œ','í•˜ë™êµ°','í•¨ì•ˆêµ°','í•¨ì–‘êµ°','í•©ì²œêµ°'],
            'ì œì£¼': ['ì„œê·€í¬ì‹œ','ì œì£¼ì‹œ']
        };
        for(let k in fullRegions) r.add(new Option(k, k));
        window.fullRegions = fullRegions;
        updateAge();
    }

    function updateArea2() {
        const s1 = document.getElementById('areaStep1').value;
        const s2 = document.getElementById('areaStep2');
        s2.options.length = 1; 
        if (s1 && window.fullRegions[s1]) {
            window.fullRegions[s1].forEach(function(district) {
                s2.add(new Option(district, district));
            });
        }
    }

    function resetFormFields() {
        document.getElementById('pageTitle').innerText = "ğŸ“ ì²´í—˜ ì‚¬ë¡€ ë“±ë¡";
        document.getElementById('editId').value = "";
        document.getElementById('userName').value = "";
        document.getElementById('descSituation').value = "";
        document.getElementById('descUsage').value = "";
        document.getElementById('descResult').value = "";
        document.getElementById('previewContainer').innerHTML = "";
        document.getElementById('areaStep1').value = "";
        document.getElementById('areaStep2').options.length = 1;
        document.getElementById('etc_input').value = "";
        document.getElementById('etc_input').style.display = "none";
        document.getElementById('symptomSelect').value = "í˜ˆë‹¹/í˜ˆì••";
    }

    function checkEditMode(id) {
        const list = JSON.parse(localStorage.getItem('exlux_cases') || '[]');
        const data = list.find(item => item.id == id);
        if(data) {
            document.getElementById('pageTitle').innerText = "ğŸ“ ì²´í—˜ ì‚¬ë¡€ ì¡°íšŒ ë° ìˆ˜ì •";
            document.getElementById('editId').value = data.id;
            document.getElementById('userName').value = data.name;
            document.getElementById('gender').value = data.gender;
            document.getElementById('usePeriod').value = data.period;
            document.getElementById('descSituation').value = data.desc1 || "";
            document.getElementById('descUsage').value = data.desc2 || "";
            document.getElementById('descResult').value = data.desc3 || "";
            const birth = data.birth.split('.');
            if(birth.length === 3) {
                document.getElementById('birthYear').value = birth[0].length==2 ? "19"+birth[0] : birth[0];
                document.getElementById('birthMonth').value = birth[1];
                document.getElementById('birthDay').value = birth[2];
            }
            const regionParts = data.region.split(' '); 
            if(regionParts.length > 0) {
                document.getElementById('areaStep1').value = regionParts[0]; 
                updateArea2(); 
                if(regionParts.length > 1) document.getElementById('areaStep2').value = regionParts[1];
            }
            if(['í˜ˆë‹¹/í˜ˆì••','ê´€ì ˆ/ë¬´ë¦','í—ˆë¦¬/ë””ìŠ¤í¬','ì–´ê¹¨/ëª©'].includes(data.symptom)) {
                document.getElementById('symptomSelect').value = data.symptom;
            } else {
                document.getElementById('symptomSelect').value = 'ê¸°íƒ€';
                document.getElementById('etc_input').style.display = 'block';
                document.getElementById('etc_input').value = data.symptom;
            }
            const container = document.getElementById('previewContainer');
            container.innerHTML = "";
            if (data.photos && data.photos.length > 0) {
                data.photos.forEach(src => { addPreviewItem(src); });
            } else if (data.photo) {
                 addPreviewItem(data.photo);
            }
            updateAge();
            if(localStorage.getItem('show_poster_immediately') === 'true') {
                makePoster(); 
                localStorage.removeItem('show_poster_immediately');
            }
        }
        localStorage.removeItem('edit_case_id');
    }

    function updateAge() { document.getElementById('ageDisplay').innerText = "ë§Œ " + (2026 - document.getElementById('birthYear').value) + "ì„¸"; }
    function toggleEtc() { document.getElementById('etc_input').style.display = (document.getElementById('symptomSelect').value === 'ê¸°íƒ€') ? 'block' : 'none'; }
    
    async function previewImages() {
        const input = document.getElementById('photoInput');
        const container = document.getElementById('previewContainer');
        const currentCount = container.children.length;
        const newFiles = input.files;
        if (currentCount + newFiles.length > 4) {
            alert("ì‚¬ì§„ì€ ìµœëŒ€ 4ì¥ê¹Œì§€ë§Œ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            input.value = ""; 
            return;
        }
        for(const f of newFiles) {
            if(f.size > 5 * 1024 * 1024) {
                alert(`'${f.name}' íŒŒì¼ì´ 5MBë¥¼ ì´ˆê³¼í•˜ì—¬ ì œì™¸ë©ë‹ˆë‹¤.`);
                continue;
            }
            try {
                const compressedSrc = await compressImage(f);
                addPreviewItem(compressedSrc);
            } catch(err) {
                console.error(err);
                alert("ì‚¬ì§„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }
        input.value = ""; 
    }

    function compressImage(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = event => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 800;
                    const scaleSize = maxWidth / img.width;
                    const finalWidth = (scaleSize < 1) ? maxWidth : img.width;
                    const finalHeight = (scaleSize < 1) ? img.height * scaleSize : img.height;
                    canvas.width = finalWidth;
                    canvas.height = finalHeight;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                };
            };
            reader.onerror = error => reject(error);
        });
    }

    function addPreviewItem(src) {
        const container = document.getElementById('previewContainer');
        if(container.children.length >= 4) return;
        const div = document.createElement('div');
        div.className = 'preview-box';
        div.innerHTML = `
            <img src="${src}">
            <button type="button" class="btn-del-photo" onclick="removePhoto(this)">X</button>
        `;
        container.appendChild(div);
    }

    function removePhoto(btn) { btn.parentElement.remove(); }

    function makePoster() {
        const name = document.getElementById('userName').value;
        if(!name) return alert("ì„±í•¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        const maskName = name[0] + "*" + (name.length>1 ? name[name.length-1] : "");
        document.getElementById('p-info').innerText = `${maskName} ë‹˜ | ${document.getElementById('ageDisplay').innerText} | ${document.getElementById('gender').value}ì„±`;
        const sym = document.getElementById('symptomSelect').value;
        document.getElementById('p-sym').innerText = (sym==='ê¸°íƒ€') ? document.getElementById('etc_input').value : sym;
        document.getElementById('p-desc1').innerText = document.getElementById('descSituation').value || "-";
        document.getElementById('p-desc2').innerText = document.getElementById('descUsage').value || "-";
        document.getElementById('p-desc3').innerText = document.getElementById('descResult').value || "-";
        const pGrid = document.getElementById('p-photos');
        pGrid.innerHTML = "";
        const previews = document.querySelectorAll('.preview-box img');
        if(previews.length > 0) {
            previews.forEach(img => { 
                const newImg = document.createElement('img');
                newImg.src = img.src;
                pGrid.appendChild(newImg);
            });
        }
        document.getElementById('posterWrapper').style.display = 'block';
        window.scrollTo(0, document.body.scrollHeight);
    }

    async function saveData() {
        const name = document.getElementById('userName').value;
        if(!name) return alert("ì„±í•¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        
        makePoster();

        const editId = document.getElementById('editId').value;
        const photoElements = document.querySelectorAll('.preview-box img');
        const photoList = Array.from(photoElements).map(img => img.src);
        const r1 = document.getElementById('areaStep1').value;
        const r2 = document.getElementById('areaStep2').value;
        const fullRegion = (r1 && r2) ? `${r1} ${r2}` : r1;
        const symVal = (document.getElementById('symptomSelect').value === 'ê¸°íƒ€') ? document.getElementById('etc_input').value : document.getElementById('symptomSelect').value;

        const newData = {
            id: editId ? Number(editId) : Date.now(),
            date: document.getElementById('regDate').value,
            name: name,
            gender: document.getElementById('gender').value,
            birth: document.getElementById('birthYear').value.substring(2) + "." + document.getElementById('birthMonth').value + "." + document.getElementById('birthDay').value,
            region: fullRegion,
            symptom: symVal,
            period: document.getElementById('usePeriod').value,
            desc1: document.getElementById('descSituation').value,
            desc2: document.getElementById('descUsage').value,
            desc3: document.getElementById('descResult').value,
            photos: photoList, 
            photo: photoList[0] || "", 
            note: 'ê³„ì†ì‚¬ìš©ì¤‘'
        };

        try {
            // 1. ë¸Œë¼ìš°ì € ë¡œì»¬ ì €ì¥
            let list = JSON.parse(localStorage.getItem('exlux_cases') || '[]');
            if(editId) {
                const idx = list.findIndex(i => i.id == editId);
                if(idx !== -1) list[idx] = newData;
            } else {
                list.push(newData);
            }
            localStorage.setItem('exlux_cases', JSON.stringify(list));
            
            // 2. GitHub ìë™ ë™ê¸°í™”
            alert("ì„œë²„(GitHub)ì™€ ë°ì´í„°ë¥¼ ë™ê¸°í™”í•©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.");
            await uploadToGithub(list);

            // 3. í¬ìŠ¤í„° ë‹¤ìš´ë¡œë“œ ë° ë§ˆë¬´ë¦¬
            if(confirm("ì €ì¥ ë° GitHub ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! \ní¬ìŠ¤í„° ì´ë¯¸ì§€(PNG)ë„ ë‚´ ì»´í“¨í„°ì— ë”°ë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                downloadPoster();
                setTimeout(() => { location.href = 'ì²´í—˜ì‚¬ë¡€ë¦¬ìŠ¤íŠ¸.html'; }, 2000);
            } else {
                location.href = 'ì²´í—˜ì‚¬ë¡€ë¦¬ìŠ¤íŠ¸.html';
            }

        } catch (e) {
            console.error(e);
            alert("âš ï¸ ë™ê¸°í™” ì‹¤íŒ¨\në„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        }
    }

    async function uploadToGithub(dataList) {
        const fileName = 'exlux_db.js';
        const content = `const exlux_cases = ${JSON.stringify(dataList)};`;
        const encodedContent = btoa(unescape(encodeURIComponent(content))); 

        const getUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${fileName}`;
        let sha = '';
        
        try {
            const res = await fetch(getUrl, {
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
            });
            if (res.ok) {
                const fileData = await res.json();
                sha = fileData.sha;
            }
        } catch (err) { console.log("ì‹ ê·œ ìƒì„± ëª¨ë“œ"); }

        const res = await fetch(getUrl, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${GITHUB_TOKEN}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: `ì²´í—˜ì‚¬ë¡€ ì—…ë°ì´íŠ¸: ${new Date().toLocaleString()}`,
                content: encodedContent,
                sha: sha
            })
        });

        if (!res.ok) throw new Error("GitHub ë™ê¸°í™” ì‹¤íŒ¨");
    }

    function downloadPoster() {
        const area = document.querySelector("#posterArea");
        html2canvas(area, { scale: 2, useCORS: true, allowTaint: true }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'ìµìŠ¤ëŸ­ìŠ¤_ì²´í—˜í¬ìŠ¤í„°_' + document.getElementById('userName').value + '.png';
            link.href = canvas.toDataURL("image/png");
            link.click();
        });
    }
</script>
</body>
</html>